#include <linux/module.h>
#include <linux/slab.h>

void *_GLOBAL_OFFSET_TABLE_ = NULL;

static const char CODE[] = {0x14,0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x0c,0x00,0x00,0x00,0x48,0x65,0x6c,0x6c,0x6f,0x20,0x77,0x6f,0x72,0x6c,0x64,0x21,0x0e,0x01,0x00,0x00,0x00,0x4a,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x0d,0x00,0x00,0x00,0x00,0x21,0x38,0x00,0x00,0x00,0x21,0x00,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0x00,0x07,0x08,0x00,0x00,0x00,0x00,0x08,0x01,0x00,0x00,0x00,0x08,0x02,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,0x00,0x06,0x21,0x01,0x00,0x00,0x00,0x21,0x00,0x04,0x00,0x00,0x21,0x0c,0x00,0x00,0x00,0x21,0x23,0x00,0x00,0x00,0x21,0x00,0x00,0x00,0x00,0x05,0x03,0x00,0x00,0x00,0x06,0x13,0x13,0x06};

extern int run_code(
    const unsigned char *code_base,
    size_t code_len,
    size_t mem_default_len,
    size_t mem_max_len,
    size_t max_slots,
    size_t stack_len,
    size_t call_stack_len,
    void *kctx
);

void lapi_printk(const char *base, size_t len) {
    printk("%.*s\n", (int) len, base);
}

unsigned char * lapi_kmalloc(size_t len) {
    return (unsigned char *) kmalloc(len, GFP_KERNEL);
}

void lapi_kfree(unsigned char *ptr) {
    kfree((char *) ptr);
}

void lapi_bug(void) {
    panic("wasm-linux bug\n");
}

void lapi_env_log(void *kctx, int level, const char *text_base, size_t text_len) {
    char *buffer;

    if(text_len > 1024) {
        return;
    }

    buffer = kmalloc(text_len + 1, GFP_KERNEL);
    memcpy(buffer, text_base, text_len);
    buffer[text_len] = 0;

    printk("[lapi_env_log] %s\n", buffer);

    kfree(buffer);
}

int __init init_module(void) {
    int ret;

    printk(KERN_INFO "wasm-linux loaded\n");
    ret = run_code(
        (const unsigned char *) CODE,
        sizeof(CODE),
        65536,
        1048576,
        16384,
        1024,
        1024,
        NULL
    );
    printk(KERN_INFO "Execution result: %d\n", ret);
    return 0;
}

void __exit cleanup_module(void) {
    printk(KERN_INFO "wasm-linux unloaded\n");
}

MODULE_LICENSE("GPL");
